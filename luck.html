<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¸è¿å¤§æŠ½å¥–</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", PingFang SC, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      min-height: 100vh;
      padding: 1.5rem 1rem;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ¡ */
    .nav-bar {
      max-width: 1200px;
      margin: 0 auto 1rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .nav-item {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2d3748;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .nav-item:hover {
      background: #f0f9f2;
      color: #1f6f4a;
    }
    .nav-item.active {
      background: #1f6f4a;
      color: #ffffff;
    }

    /* æ»šåŠ¨å…¬å‘Š */
    .notice-bar {
      max-width: 1200px;
      margin: 0 auto 1.5rem;
      height: 40px;
      line-height: 40px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      position: relative;
      padding: 0 2rem;
    }
    .notice-content {
      position: absolute;
      white-space: nowrap;
      color: #d63384;
      font-weight: 500;
      animation: noticeScroll 25s linear infinite;
    }
    @keyframes noticeScroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* ä¸»å®¹å™¨ï¼šå·¦å³å¸ƒå±€ï¼Œå³å®½å·¦çª„ */
    .lottery-main {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    /* å·¦ä¾§ï¼šå¥–å“å±•ç¤º */
    .prize-side {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 2rem;
    }
    /* å³ä¾§ï¼šæŠ½å¥–ä¸»ä½“ï¼ˆæ›´å®½ï¼‰ */
    .lottery-side {
      flex: 2;
      min-width: 400px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      padding: 2rem;
      position: relative;
    }

    /* å·¦ä¾§å¥–å“å±•ç¤º */
    .prize-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 1.5rem;
      padding-left: 0.5rem;
      border-left: 4px solid #1f6f4a;
    }
    .prize-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1.2rem;
    }
    .prize-card {
      background: #f9fafc;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    .prize-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
    }
    .prize-level {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .prize-name {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.3rem;
    }
    .prize-desc {
      font-size: 0.8rem;
      color: #999;
    }

    /* å³ä¾§ï¼šå³ä¸Šæ–¹å‰©ä½™æ¬¡æ•° */
    .lottery-count {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: #ef4444;
      color: #fff;
      padding: 0.5rem 1.2rem;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 700;
    }
    .lottery-count span {
      color: #FFD700;
      font-size: 1.2rem;
      margin: 0 0.2rem;
    }

    /* æŠ½å¥–æœºæ ‡é¢˜ */
    .lottery-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 1.5rem;
      margin-top: 1rem;
    }

    /* çŸ©å½¢æ‘‡å·æœºï¼šå°çƒç¢°è¾¹ç¼˜å›å¼¹æ ¸å¿ƒå®¹å™¨ */
    .lottery-machine {
      width: 100%;
      height: 300px;
      border: 3px solid #1f6f4a;
      border-radius: 16px;
      background: #f0f9f2;
      position: relative;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    /* æŠ½å¥–ç»“æœåŒº */
    .lottery-result {
      width: 100%;
      height: 60px;
      line-height: 60px;
      text-align: center;
      font-size: 1.3rem;
      font-weight: 700;
      color: #333;
      border: 2px dashed #e8ebf0;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    /* æŠ½å¥–æŒ‰é’® */
    #lotteryBtn {
      width: 100%;
      height: 56px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(90deg, #1f6f4a, #185c3c);
      color: #fff;
      font-size: 1.3rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #lotteryBtn:hover {
      background: linear-gradient(90deg, #185c3c, #1f6f4a);
      box-shadow: 0 6px 15px rgba(31, 111, 74, 0.3);
    }
    #lotteryBtn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
    }

    /* ä¸­å¥–å¼¹çª— */
    .prize-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 2rem 3rem;
      min-width: 360px;
      text-align: center;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    .prize-modal.show {
      opacity: 1;
      pointer-events: all;
    }
    .prize-modal.show .modal-content {
      transform: scale(1);
    }
    .modal-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .modal-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 1rem;
    }
    .modal-prize {
      font-size: 1.2rem;
      line-height: 1.8;
      margin-bottom: 2rem;
      color: #666;
    }
    .modal-prize strong {
      color: #1f6f4a;
      font-size: 1.3rem;
    }
    .modal-close {
      padding: 0.8rem 3rem;
      border: none;
      border-radius: 8px;
      background: #1f6f4a;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .modal-close:hover {
      background: #185c3c;
    }

    /* å°çƒæ ·å¼ï¼šè§†è§‰æ¸…æ™°ï¼Œå›å¼¹æ›´æ˜æ˜¾ */
    .lottery-ball {
      position: absolute;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
      font-size: 14px;
      z-index: 10;
      transition: none;
    }

    /* å“åº”å¼é€‚é… */
    @media (max-width: 992px) {
      .lottery-main {
        flex-direction: column;
      }
      .lottery-side, .prize-side {
        min-width: 300px;
      }
    }
    @media (max-width: 768px) {
      .nav-bar {
        justify-content: center;
        gap: 1rem;
        padding: 0.8rem 1.5rem;
      }
      .nav-item {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
      }
      .lottery-machine {
        height: 240px;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 1rem 0.5rem;
      }
      .prize-side, .lottery-side {
        padding: 1.5rem 1rem;
      }
      .lottery-count {
        top: 1.5rem;
        right: 1.5rem;
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
      }
      .modal-content {
        min-width: 300px;
        padding: 1.5rem 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div class="nav-bar">
    <a href="second-page.html" class="nav-item">é¦–é¡µ</a>
    <a href="https://daziya.com/" target="_blank" class="nav-item">æ‰“å­—ç»ƒä¹ </a>
    <a href="time.html" class="nav-item">è®¡æ—¶å™¨</a>
    <div class="nav-item active">å¹¸è¿æŠ½å¥–</div>
    <div class="nav-item" id="navLogout">é€€å‡ºç™»å½•</div>
  </div>

  <!-- æ»šåŠ¨å…¬å‘Š -->
  <div class="notice-bar">
    <div class="notice-content" id="noticeContent"></div>
  </div>

  <!-- ä¸»å†…å®¹ï¼šå·¦å³å¸ƒå±€ -->
  <div class="lottery-main">
    <!-- å·¦ä¾§å¥–å“å±•ç¤º -->
    <div class="prize-side">
      <div class="prize-title">å¥–å“å±•ç¤º</div>
      <div class="prize-list" id="prizeList"></div>
    </div>

    <!-- å³ä¾§æŠ½å¥–ä¸»ä½“ -->
    <div class="lottery-side">
      <div class="lottery-count">å‰©ä½™æ¬¡æ•°ï¼š<span id="leftCount">0</span></div>
      <div class="lottery-title">å¹¸è¿æ‘‡å·æœº</div>
      <div class="lottery-machine" id="lotteryMachine"></div>
      <div class="lottery-result" id="lotteryResult">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æŠ½å¥–</div>
      <button id="lotteryBtn" disabled>ç«‹å³æŠ½å¥–</button>
    </div>
  </div>

  <!-- ä¸­å¥–å¼¹çª— -->
  <div class="prize-modal" id="prizeModal">
    <div class="modal-content">
      <div class="modal-icon" id="modalIcon">ğŸ‰</div>
      <div class="modal-title" id="modalTitle">æ­å–œä¸­å¥–ï¼</div>
      <div class="modal-prize" id="modalPrize"></div>
      <button class="modal-close" id="modalClose">ç¡®å®š</button>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡ï¼šä»…å£°æ˜ï¼Œæ— ä»»ä½•é»˜è®¤æ•°æ®
    let CONFIG = {}; // ä»JSONåŠ è½½çš„é…ç½®å®¹å™¨
    let prizeList = [], leftCount = 0, totalWeight = 0;
    let isRunning = false, rollTimer = null;
    let balls = [], machineW = 0, machineH = 0;
    const BALL_R = 20; // å°çƒå›ºå®šåŠå¾„ï¼ˆéé…ç½®é¡¹ï¼Œä¿ç•™ï¼‰

    // DOMå…ƒç´ è·å–ï¼šä¸€æ¬¡æ€§è·å–ï¼Œæ— ç¡¬ç¼–ç æ•°æ®
    const $ = id => document.getElementById(id);
    const el = {
      navLogout: $('navLogout'),
      noticeContent: $('noticeContent'),
      leftCount: $('leftCount'),
      prizeList: $('prizeList'),
      lotteryMachine: $('lotteryMachine'),
      lotteryResult: $('lotteryResult'),
      lotteryBtn: $('lotteryBtn'),
      prizeModal: $('prizeModal'),
      modalIcon: $('modalIcon'),
      modalTitle: $('modalTitle'),
      modalPrize: $('modalPrize'),
      modalClose: $('modalClose')
    };

    // é¡µé¢åˆå§‹åŒ–ï¼šå¼‚æ­¥åŠ è½½JSONé…ç½®ï¼Œæ— ç¡¬ç¼–ç æ•°æ®
    window.onload = async () => {
      try {
        // åŠ è½½åŒæ–‡ä»¶å¤¹ä¸‹çš„lottery-config.json
        const response = await fetch('lottery-config.json');
        if (!response.ok) throw new Error('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + response.status);
        CONFIG = await response.json(); // èµ‹å€¼é…ç½®ï¼Œåç»­æ‰€æœ‰é€»è¾‘åŸºäºæ­¤

        // åˆå§‹åŒ–é…ç½®å˜é‡
        prizeList = CONFIG.prizeList;
        leftCount = CONFIG.lotteryCount;
        totalWeight = prizeList.reduce((sum, item) => sum + item.weight, 0);
        machineW = el.lotteryMachine.offsetWidth;
        machineH = el.lotteryMachine.offsetHeight;

        // æ¸²æŸ“é¡µé¢æ¨¡å—ï¼ˆæ•°æ®å‡æ¥è‡ªJSONï¼‰
        el.noticeContent.innerText = CONFIG.noticeList.join(' ï½œ ');
        renderLeftCount();
        renderPrizeList();
        initBalls();
        el.lotteryBtn.disabled = leftCount <= 0;

        // çª—å£å¤§å°å˜åŒ–é€‚é…
        window.onresize = () => {
          machineW = el.lotteryMachine.offsetWidth;
          machineH = el.lotteryMachine.offsetHeight;
        };
      } catch (err) {
        // é…ç½®åŠ è½½å¤±è´¥çš„å‹å¥½æç¤º
        console.error('åˆå§‹åŒ–å¤±è´¥ï¼š', err);
        el.lotteryResult.innerText = 'é…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥JSONæ–‡ä»¶ï¼';
        el.lotteryResult.style.color = '#ef4444';
      }
    };

    // æ¸²æŸ“å‰©ä½™æŠ½å¥–æ¬¡æ•°
    function renderLeftCount() {
      el.leftCount.innerText = leftCount;
      el.lotteryBtn.disabled = leftCount <= 0 || isRunning;
    }

    // æ¸²æŸ“å·¦ä¾§å¥–å“åˆ—è¡¨ï¼ˆæ•°æ®æ¥è‡ªJSONçš„prizeListï¼‰
    function renderPrizeList() {
      el.prizeList.innerHTML = prizeList.map(item => `
        <div class="prize-card">
          <div class="prize-level" style="color: ${item.color}">${item.name}</div>
          <div class="prize-name">${item.prize}</div>
          <div class="prize-desc">${item.desc}</div>
        </div>
      `).join('');
    }

    // åˆå§‹åŒ–å°çƒï¼ˆæŒ‰JSONå¥–å“æƒé‡ç”Ÿæˆï¼Œæ— ç¡¬ç¼–ç ï¼‰
    function initBalls() {
      el.lotteryMachine.innerHTML = '';
      balls = [];
      const scale = 0.15; // å°çƒæ•°é‡ç¼©æ”¾ç³»æ•°ï¼ˆéé…ç½®é¡¹ï¼Œä¿ç•™ï¼‰

      prizeList.forEach(prize => {
        const ballNum = Math.max(1, Math.round(prize.weight * scale));
        for (let i = 0; i < ballNum; i++) createSingleBall(prize);
      });

      // å°çƒåˆå§‹ä½ç½®/é€Ÿåº¦éšæœº
      balls.forEach(ball => {
        ball.x = Math.random() * (machineW - 2 * BALL_R) + BALL_R;
        ball.y = Math.random() * (machineH - 2 * BALL_R) + BALL_R;
        ball.vx = (Math.random() - 0.5) * 3;
        ball.vy = (Math.random() - 0.5) * 3;
      });
      updateBallPos();
    }

    // åˆ›å»ºå•ä¸ªå°çƒï¼ˆæ ·å¼æ¥è‡ªJSONçš„å¥–å“color/nameï¼‰
    function createSingleBall(prize) {
      const ballEl = document.createElement('div');
      ballEl.className = 'lottery-ball';
      ballEl.style.width = ballEl.style.height = `${BALL_R * 2}px`;
      ballEl.style.backgroundColor = prize.color;
      ballEl.innerText = prize.name.substring(0, 1);
      el.lotteryMachine.appendChild(ballEl);

      balls.push({
        el: ballEl,
        prize: prize,
        x: 0, y: 0,
        vx: 0, vy: 0
      });
    }

    // æ›´æ–°å°çƒDOMä½ç½®
    function updateBallPos() {
      balls.forEach(ball => {
        ball.el.style.left = `${ball.x - BALL_R}px`;
        ball.el.style.top = `${ball.y - BALL_R}px`;
      });
    }

    // æ ¸å¿ƒï¼šæŠ½å¥–åŠ¨ç”»ï¼ˆå°çƒç¢°è¾¹ç¼˜å›å¼¹ï¼Œæ— ç¡¬ç¼–ç ï¼‰
    function startLottery() {
      if (isRunning || leftCount <= 0) return;
      isRunning = true;
      leftCount--;
      renderLeftCount();
      el.lotteryResult.innerText = 'æ‘‡çƒä¸­......';
      el.lotteryResult.style.color = '#333';

      // åˆå§‹åŒ–æŠ½å¥–é«˜é€Ÿ
      balls.forEach(ball => {
        const speed = 8 + Math.random() * 12;
        const angle = Math.random() * Math.PI * 2;
        ball.vx = Math.cos(angle) * speed;
        ball.vy = Math.sin(angle) * speed;
      });

      // é«˜é¢‘åˆ·æ–°åŠ¨ç”»
      rollTimer = setInterval(() => {
        balls.forEach(ball => {
          ball.x += ball.vx;
          ball.y += ball.vy;

          // ç¢°è¾¹ç¼˜ç²¾å‡†å›å¼¹
          if (ball.x <= BALL_R) {
            ball.x = BALL_R;
            ball.vx *= -1;
          } else if (ball.x >= machineW - BALL_R) {
            ball.x = machineW - BALL_R;
            ball.vx *= -1;
          }
          if (ball.y <= BALL_R) {
            ball.y = BALL_R;
            ball.vy *= -1;
          } else if (ball.y >= machineH - BALL_R) {
            ball.y = machineH - BALL_R;
            ball.vy *= -1;
          }
        });
        updateBallPos();
      }, 10);

      // å¼€å¥–é€»è¾‘
      setTimeout(() => {
        clearInterval(rollTimer);
        const winPrize = calcWinner();
        highlightWinBall(winPrize);
        showResult(winPrize);
        isRunning = false;
      }, 3000);
    }

    // æŒ‰JSONæƒé‡è®¡ç®—ä¸­å¥–ç»“æœ
    function calcWinner() {
      const randomVal = Math.random() * totalWeight;
      let weightSum = 0;
      for (const prize of prizeList) {
        weightSum += prize.weight;
        if (randomVal < weightSum) return prize;
      }
      return prizeList[prizeList.length - 1];
    }

    // é«˜äº®ä¸­å¥–å°çƒ
    function highlightWinBall(winPrize) {
      const winBalls = balls.filter(ball => ball.prize.id === winPrize.id);
      if (winBalls.length === 0) return;
      const targetBall = winBalls[Math.floor(Math.random() * winBalls.length)];

      targetBall.x = machineW / 2;
      targetBall.y = machineH / 2;
      targetBall.vx = 0;
      targetBall.vy = 0;
      targetBall.el.style.transform = 'scale(1.8)';
      targetBall.el.style.zIndex = 99;
      updateBallPos();
    }

    // æ˜¾ç¤ºæŠ½å¥–ç»“æœï¼ˆå†…å®¹æ¥è‡ªJSONï¼‰
    function showResult(prize) {
      el.lotteryResult.innerText = `æ­å–œæŠ½ä¸­ï¼š${prize.name} - ${prize.prize}`;
      el.lotteryResult.style.color = prize.color;

      if (prize.id === prizeList.findIndex(item => item.name === 'è°¢è°¢æƒ é¡¾')) {
        el.modalIcon.innerText = 'ğŸ’ª';
        el.modalTitle.innerText = 'å†æ¥å†å‰ï¼';
        el.modalPrize.innerHTML = `å¾ˆé—æ†¾ï¼Œä½ è·å¾—<br/><strong style="color:${prize.color}">ã€${prize.name}ã€‘</strong><br/>${prize.desc}`;
      } else {
        el.modalIcon.innerText = 'ğŸ‰';
        el.modalTitle.innerText = 'æ­å–œä¸­å¥–ï¼';
        el.modalPrize.innerHTML = `ä½ æŠ½ä¸­äº†<br/><strong style="color:${prize.color}">ã€${prize.name}ã€‘</strong><br/>${prize.prize}<br/>${prize.desc}`;
      }
      el.modalTitle.style.color = prize.color;
      el.prizeModal.classList.add('show');
    }

    // äº‹ä»¶ç»‘å®š
    el.lotteryBtn.addEventListener('click', startLottery);
    el.modalClose.addEventListener('click', () => {
      el.prizeModal.classList.remove('show');
      balls.forEach(ball => {
        ball.el.style.transform = 'scale(1)';
        ball.el.style.zIndex = 10;
      });
      renderLeftCount();
    });
    el.navLogout.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) window.close();
    });
    window.addEventListener('beforeunload', () => {
      clearInterval(rollTimer);
    });
  </script>
</body>
</html>